<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: docLogin.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: docLogin.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const mysql = require('mysql');
const jwt = require("jsonwebtoken");
const getConnection = require('../ddbb/mysql');
const nodemailer = require("nodemailer");
/**
 * @fileoverview Controlador de funciones de login
 *
 * @author  Gerardo Mir
*/
const User = {
    start: async (req, res) => {
        res.render("../views/login.ejs");
    },
    forgot: async (req, res) => {
        res.render("../views/forgot.ejs");
    },
    confirmation: async (req, res) => {
        res.render("../views/confirmacion.ejs");
    },
    /**
     * Este middleware recoge el usuario, crea el token de acceso y redirecciona a los paneles de usuario
     * @param {*} req 
     * @param {*} res 
     * @returns redirección a panel de usuario
     */
    getUser: async (req, res) => {
        const { email, password } = req.body;
        let con = await getConnection();
        // validar correo 
        if (!email || !password) return res.status(400).json({ error: 'Por favor introduce tus credenciales correctamente' });
        // se busca el usuario por email en la base de datos, el email es UNIQUE
        let selectQuery = 'SELECT * FROM ?? WHERE ?? = ?';
        let query = mysql.format(selectQuery, ['users', 'email', email]);
        let query2 = mysql.format(selectQuery, ['app_admins', 'email', email]);
        let user = await con.query(query);
        let admin = await con.query(query2);

        if (!user[0] &amp;&amp; !admin[0]) return res.status(400).json({ error: 'Usuario no encontrado' });
        if (user[0]) {
            let validUser = user[0].user_pass;
            if (password != validUser) return res.status(400).json({ error: 'contraseña no válida' })
            // create token
            const token = jwt.sign({
                email: user[0].email,
                id_user: user[0].id_user
            }, process.env.TOKEN_SECRET, { expiresIn: '600000' })
            res.location(`/userDash/${token}`);
            res.sendStatus(302);
        }
        if (admin[0]) {
            let validAdmin = admin[0].admin_pass;
            if (password != validAdmin) return res.status(400).json({ error: 'contraseña no válida' })
            // create token
            const token = jwt.sign({
                email: admin[0].email,
                id_admin: admin[0].id_admin

            }, process.env.TOKEN_SECRET, { expiresIn: '600000' })
            res.location(`/admin/${token}`);
            res.sendStatus(302);
        }
    },
    /**
     * Envía un email con el token al usuario para poder cambiar la contraseña
     * @param {*} req 
     * @param {*} res 
     */
    sendEmail: async (req, res) => {
        const { email } = req.body;
        let con = await getConnection();

        let selectQuery = 'SELECT * FROM ?? WHERE ?? = ?';
        let query = mysql.format(selectQuery, ['users', 'email', email]);
        let query2 = mysql.format(selectQuery, ['app_admins', 'email', email]);
        let user = await con.query(query);
        let admin = await con.query(query2);
        // Establece el envío SMTP
        let transporter = nodemailer.createTransport({
            host: 'smtp.ethereal.email',
            port: 587,
            secure: false, // true for 465, false for other ports
            auth: {
                user: process.env.transporter_user,
                pass: process.env.transporter_pass
            }
        });
        if (!user[0] &amp;&amp; !admin[0]) return res.status(400).json({ error: 'Usuario no encontrado' });
        // Crea el token de usuario
        if (user[0]) {
            const token = jwt.sign({
                email: user[0].email,
                id_user: user[0].id_user
            }, process.env.TOKEN_SECRET, { expiresIn: '30000' })
            // Crea el mensaje que se va a enviar
            let message = {
                from: 'apu shop &lt;sender@example.com>',
                to: user[0].email,
                subject: 'Link para cambiar tu contraseña',
                text: '',
                html: 'Hola, haz click en este link para cambiar tu contraseña&lt;br>' + `&lt;a href="http://localhost:3000/login/confirmacion/${token}" target="_blank" rel="external">http://localhost:3000/confirmacion/${token}&lt;/a>`
            };
            // Envia el correo con el enlace
            transporter.sendMail(message, (err, info) => {
                if (err) {
                    console.log('Hubo un error en el envío ' + err.message);
                    return process.exit(1);
                }
                // Imprime en el backend la confirmación del envío
                console.log('Message sent: %s', info.messageId);
                // Te muestra el enlace para acceder a un cliente del correo que muestra el mensaje que recibiría el cliente
                console.log('Preview URL: %s', nodemailer.getTestMessageUrl(info));
            });
        }
        if (admin[0]) {
            // Crea el token de admin
            const token = jwt.sign({
                email: admin[0].email,
                id_admin: admin[0].id_admin
            }, process.env.TOKEN_SECRET, { expiresIn: '30000' })

            // Crea el mensaje que se va a enviar
            let message = {
                from: 'apu shop &lt;sender@example.com>',
                to: admin[0].email,
                subject: 'Link para cambiar tu contraseña',
                text: '',
                html: 'Hola, haz click en este link para cambiar tu contraseña&lt;br>' + `&lt;a href="http://localhost:3000/login/confirmacion/${token}" target="_blank" rel="external">http://localhost:3000/confirmacion/${token}&lt;/a>`
            };

            // Envia el correo con el enlace
            transporter.sendMail(message, (err, info) => {
                if (err) {
                    console.log('Hubo un error en el envío ' + err.message);
                    return process.exit(1);
                }
                // Imprime en el backend la confirmación del envío
                console.log('Message sent: %s', info.messageId);
                // Te muestra el enlace para acceder a un cliente del correo que muestra el mensaje que recibiría el cliente
                console.log('Preview URL: %s', nodemailer.getTestMessageUrl(info));
            });
        }
        res.render("../views/email_sent.ejs")
    },
    /**
     * Hace update del password a través del login de confirmación con token
     * @param {*} req 
     * @param {*} res 
     */
    updatePassword: async (req, res) => {
        const { password1 } = req.body;
        const { password2 } = req.body;
        const { token } = req.params;
        let match = password1 == password2;
        if (!match) return res.status(400).json({ error: 'Las contraseñas no coinciden' });
        let con = await getConnection();

        // Recoge de la información del usuario del token, el email para buscarlo en la BD y actualizar el password
        let info = JSON.parse(Buffer.from(token.split('.')[1], 'base64').toString());
        let updateQuery = "UPDATE ?? SET ?? = ? WHERE ?? = ?";
        if (info.id_user) {
            let query = mysql.format(updateQuery, ["users", "user_pass", password1, "email", info.email]);
            await con.query(query);
            res.render("../views/new_password.ejs")
        } else {
            let query2 = mysql.format(updateQuery, ["app_admins", "admin_pass", password1, "email", info.email]);
            try {
                await con.query(query2);
            }
            catch (error) {
                console.log(`ERROR: ${error.stack}`);
            }

        }
        res.render("../views/new_password.ejs")
    }
}
module.exports = User;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#Register">Register</a></li><li><a href="global.html#addUser">addUser</a></li><li><a href="global.html#deleteUser">deleteUser</a></li><li><a href="global.html#encryptUserPass">encryptUserPass</a></li><li><a href="global.html#getUser">getUser</a></li><li><a href="global.html#unsubscribeForm">unsubscribeForm</a></li><li><a href="global.html#updatePass">updatePass</a></li><li><a href="global.html#updateUser">updateUser</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.0</a> on Tue Nov 22 2022 11:02:42 GMT+0100 (hora estándar de Europa central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
